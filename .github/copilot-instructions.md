# AI agent guide for this repo

Goal: make AI helpers productive on this Next.js + Drizzle + Postgres app for generating/studying multi-choice questions.

## Architecture and flow
- Next.js 15 (App Router) + TypeScript + Tailwind. UI under `src/app/**`, API routes under `src/app/api/**`.
- Data via Drizzle ORM (postgres-js). Canonical schema: `src/db/schema.ts`; migrations output in `drizzle/` (generated by drizzle-kit).
- Core contract: `Question` in `src/lib/schema.ts` (zod) with fields:
  - `question: string`, `choices: string[] (2..8)`, `answerIndexes: number[] (unique, 0-based)`, `explanations: string[] (same length as choices)`.
- Generation: `src/lib/generate-questions.ts` uses Vercel AI SDK `generateObject` with OpenAI. It enforces:
  - exact `choiceCount` (2..8), exact K correct answers per question, normalization (shuffle + remap) via `normalizeQuestion`.
- Server actions in `src/app/actions.ts` handle CRUD and call `revalidatePath` for `/`, `/saved`, `/practice`, `/admin/*`.

## Dev, DB, and scripts
- DB: Docker Postgres (`docker-compose.yml`). Typical local env: `DATABASE_URL=postgresql://postgres:postgres@localhost:5432/qualification_train`.
- DB client note: `src/db/client.ts` logs a warning if `DATABASE_URL` is missing instead of throwing; the app can boot in mock mode but any DB call will fail.
- Migrations: edit `src/db/schema.ts` → `npm run db:generate` → `npm run db:migrate`. Do not hand-edit files under `drizzle/`.
- Scripts: `npm run dev`, `npm run typecheck`, `npm run build`, `npm run lint`.
- Mock mode: if `OPENAI_API_KEY` is missing, generation and chat return deterministic mock outputs. Preserve this for offline demos.

## AI integration (project rules)
- Provider: `@ai-sdk/openai` via Vercel AI SDK (`generateObject` for JSON, `generateText` for chat).
- Model allow-lists:
  - Questions: `gpt-5 | gpt-5-mini | gpt-4.1 | gpt40` (fallback `gpt-4.1`). See `src/lib/generate-questions.ts`.
  - Chat: `gpt-5 | gpt-5-mini | gpt-4.1 | gpt-4o` (fallback `gpt-4o`). See `src/app/api/chat/route.ts`.
- Prompting: templates + optional system prompt in table `prompts`; admin UI at `/admin/prompts`. Placeholders are plain replacements:
  `{genre} {subgenre} {topic} {count} {choiceCount} {minCorrect} {maxCorrect}`. Defaults in `src/lib/default-prompts.ts`.

## API surfaces (examples)
- POST `/api/questions/generate`: body supports `genre, subgenre, topic, count(1..50), model, minCorrect, maxCorrect, concurrency(1..4), choiceCount(2..8), promptName` → `{ questions: Question[] }`.
- POST `/api/chat`: `{ messages, contextQuestions?: Question[], contextOptions?, model? }` → `{ answer: string }`.
- GET `/api/genres`, `/api/subgenres?genreId=...`; GET `/api/keywords?genreId=...` and POST `/api/keywords`; GET `/api/prompts`.

## Conventions and gotchas
- Validate external I/O with zod (see route body schemas and `QuestionSchema`). Keep `choices.length === explanations.length` at all times.
- Client UI shuffling: `src/components/question-display.tsx` shuffles choices after mount to avoid SSR mismatch—do not pre-shuffle on the server.
- Keywords are genre-scoped with unique index `(genre_id, name)`; duplicates are ignored in actions.

## Extending safely
- Data/table changes: `src/db/schema.ts` → generate/migrate.
- Generation rules/templates: `src/lib/generate-questions.ts`, `src/lib/default-prompts.ts`.
- Admin flows and CRUD: `src/app/actions.ts` and pages under `src/app/admin/**`.
- After DB mutations in actions, mirror existing `revalidatePath` calls for affected pages.